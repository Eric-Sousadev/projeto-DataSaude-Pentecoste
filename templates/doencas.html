{% extends "base.html" %}
{% block content %}

<h1 class="page-title">Tabela de Doenças</h1>

<!-- SEçãO DE FILTROS INTERATIVOS -->
<div class="filters-section">
  <div class="filters-header">
    <h3 class="filters-title"> Filtrar Dados</h3>
  </div>

  <div class="filters-container">
    <!-- Campo de Busca por Texto -->
    <div class="filter-group">
      <label for="searchInput" class="filter-label">Buscar</label>
      <input 
        type="text" 
        id="searchInput" 
        class="filter-input" 
        placeholder="Digite para buscar..."
      >
    </div>

    <!-- Filtro por Ano -->
    <div class="filter-group">
      <label for="yearFilter" class="filter-label">Ano</label>
      <select id="yearFilter" class="filter-select">
        <option value="">Todos</option>
        <option value="2021">2021</option>
        <option value="2022">2022</option>
        <option value="2023">2023</option>
      </select>
    </div>

    <!-- Filtro por Mês -->
    <div class="filter-group">
      <label for="monthFilter" class="filter-label">Mês</label>
      <select id="monthFilter" class="filter-select">
        <option value="">Todos</option>
        <option value="1">Janeiro</option>
        <option value="2">Fevereiro</option>
        <option value="3">Março</option>
        <option value="4">Abril</option>
        <option value="5">Maio</option>
        <option value="6">Junho</option>
        <option value="7">Julho</option>
        <option value="8">Agosto</option>
        <option value="9">Setembro</option>
        <option value="10">Outubro</option>
        <option value="11">Novembro</option>
        <option value="12">Dezembro</option>
      </select>
    </div>

    <!-- (campo Doença removido) -->

    <!-- Filtro por Bairro -->
    <div class="filter-group">
      <label for="neighborhoodFilter" class="filter-label">Bairro</label>
      <select id="neighborhoodFilter" class="filter-select">
        <option value="">Todos</option>
      </select>
    </div>

    <!-- Botão Limpar -->
    <div class="filter-group filter-button-group">
      <div style="display:flex; gap:10px;">
        <button id="applyFilters" class="toggle-btn">Aplicar Filtros</button>
        <button id="clearFilters" class="filter-btn-clear">Limpar Filtros</button>
      </div>
    </div>
  </div>

  <div class="filter-info">
    <span id="resultCount">Mostrando todos os registros</span>
  </div>
</div>

<div class="tabela-container">
    {{ tabela|safe }}
</div>

<script>
// ===============================================
// SISTEMA DE FILTROS INTERATIVOS
// ===============================================

document.addEventListener('DOMContentLoaded', function() {
  // ===== ELEMENTOS DO DOM =====
  const searchInput = document.getElementById('searchInput');
  const yearFilter = document.getElementById('yearFilter');
  const monthFilter = document.getElementById('monthFilter');
  const neighborhoodFilter = document.getElementById('neighborhoodFilter');
  const clearButton = document.getElementById('clearFilters');
  const applyButton = document.getElementById('applyFilters');
  const resultCount = document.getElementById('resultCount');
  const table = document.querySelector('table');

  // Se a tabela não existir, sair
  if (!table) return;

  // ===== DADOS ORIGINAIS =====
  let originalRows = [];
  let allNeighborhoods = new Set();

  // ===== INICIALIZAçãO =====
  function initializeFilters() {
    // Capturar todas as linhas da tabela (excluindo header)
    const tbody = table.querySelector('tbody');
    if (!tbody) return;
    
    originalRows = Array.from(tbody.querySelectorAll('tr'));
    
    // Extrair bairros unicos dinamicamente
    originalRows.forEach(row => {
      const cells = row.querySelectorAll('td');
      if (cells.length > 0) {
        // bairro esta no indice 3
        const bairroCell = cells[3];
        if (bairroCell) {
          allNeighborhoods.add(bairroCell.textContent.trim());
        }
      }
    });

    // Popular dropdown de bairros
    populateNeighborhoodFilter();
  }

  // ===== POPULAR DROPDOWN DE BAIRROS =====
  function populateNeighborhoodFilter() {
    const neighborhoods = Array.from(allNeighborhoods).sort();
    
    neighborhoods.forEach(neighborhood => {
      if (neighborhood) {
        const option = document.createElement('option');
        option.value = neighborhood;
        option.textContent = neighborhood;
        neighborhoodFilter.appendChild(option);
      }
    });
  }

  // ===== APLICAR FILTROS =====
  function applyFilters() {
    const searchTerm = searchInput.value.toLowerCase();
    const yearValue = yearFilter.value;
    const monthValue = monthFilter.value;
    const neighborhoodValue = neighborhoodFilter.value;

    let visibleCount = 0;

    // helper: compara anos mesmo se tabela mostrar '2023.0' ou '2023'
    function matchesYear(cellYearText, filterYear) {
      if (!filterYear) return true;
      if (!cellYearText) return false;
      const parsed = parseInt(cellYearText, 10);
      const fy = parseInt(filterYear, 10);
      if (!isNaN(parsed) && !isNaN(fy)) return parsed === fy;
      // fallback: comparar conteúdo textual
      return cellYearText.toString().includes(filterYear.toString());
    }

    // helper: compara mês (tenta converter para número também)
    function matchesMonth(cellMonthText, filterMonth) {
      if (!filterMonth) return true;
      if (!cellMonthText) return false;
      const parsed = parseInt(cellMonthText, 10);
      const fm = parseInt(filterMonth, 10);
      if (!isNaN(parsed) && !isNaN(fm)) return parsed === fm;
      return cellMonthText.toString().includes(filterMonth.toString());
    }

    originalRows.forEach(row => {
      const cells = row.querySelectorAll('td');
      const rowText = row.textContent.toLowerCase();

      // Extrair valores da linha (indices corretos)
      const anoCell = (cells[1]?.textContent || '').trim();
      const mesCell = (cells[2]?.textContent || '').trim();
      const bairro = (cells[3]?.textContent || '').trim();

      const matchSearch = rowText.includes(searchTerm);
      const matchYear = matchesYear(anoCell, yearValue);
      const matchMonth = matchesMonth(mesCell, monthValue);
      const matchNeighborhood = !neighborhoodValue || bairro === neighborhoodValue;

      const isVisible = matchSearch && matchYear && matchMonth && matchNeighborhood;

      row.style.display = isVisible ? '' : 'none';
      if (isVisible) visibleCount++;
    });

    updateResultCount(visibleCount, originalRows.length);
  }

  // ===== ATUALIZAR CONTADOR DE RESULTADOS =====
  function updateResultCount(visible, total) {
    if (visible === total) {
      resultCount.textContent = `Mostrando todos os ${total} registros`;
    } else {
      resultCount.textContent = `Mostrando ${visible} de ${total} registros`;
    }
  }

  // ===== LIMPAR FILTROS =====
  function clearAllFilters() {
    searchInput.value = '';
    yearFilter.value = '';
    monthFilter.value = '';
    neighborhoodFilter.value = '';
    // mostrar todas as linhas e atualizar contador
    originalRows.forEach(row => row.style.display = '');
    updateResultCount(originalRows.length, originalRows.length);
  }

  // ===== EVENT LISTENERS =====
  // agora os filtros só são aplicados ao clicar em 'Aplicar Filtros'
  if (applyButton) applyButton.addEventListener('click', applyFilters);
  clearButton.addEventListener('click', clearAllFilters);

  // ===== INICIAR =====
  initializeFilters();
});
</script>

{% endblock %}
